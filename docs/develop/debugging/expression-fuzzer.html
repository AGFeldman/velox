
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Expression Fuzzer &#8212; Velox  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Monthly Updates" href="../../monthly-updates.html" />
    <link rel="prev" title="VectorSaver: Encoding-Preserving Serialization" href="vector-saver.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../monthly-updates.html" title="Monthly Updates"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="vector-saver.html" title="VectorSaver: Encoding-Preserving Serialization"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Velox  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../develop.html" >Developer Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../debugging.html" accesskey="U">Debugging Tools</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Expression Fuzzer</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="expression-fuzzer">
<h1>Expression Fuzzer<a class="headerlink" href="#expression-fuzzer" title="Permalink to this heading">¶</a></h1>
<p>Velox allows users to define UDFs and provides an expression fuzzer tool to
test expression evaluation engine and UDFs thoroughly. It is being used to
test builtin Presto and Spark UDFs and has discovered numerous bugs caused
by corner cases that are difficult to cover in unit tests.</p>
<p>The expression fuzzer generates random expressions and evaluates these on
random input vectors. Each generated expression may contain multiple sub-
expressions and each input vector can have random and potentially nested
encodings.</p>
<p>To ensure that evaluation engine and UDFs handle vector encodings correctly,
the expression fuzzer evaluates an expression twice and asserts the results to
be the same: using regular evaluation path and using simplified evaluation that
flattens all input vectors before evaluating an expression.</p>
<section id="how-to-integrate-with-expression-fuzzer">
<h2>How to integrate with expression fuzzer<a class="headerlink" href="#how-to-integrate-with-expression-fuzzer" title="Permalink to this heading">¶</a></h2>
<p>Integrating with the expression fuzzer is simple. All you need to do is to
create a test, register all the custom UDFs and the Velox built-in UDFs that
the engine is going to support, and call <code class="docutils literal notranslate"><span class="pre">FuzzerRunner::run()</span></code> defined in
<a class="reference external" href="https://github.com/facebookincubator/velox/blob/main/velox/expression/tests/ExpressionFuzzer.h">FuzzerRunner.h</a>. An example can be found at
<a class="reference external" href="https://github.com/facebookincubator/velox/blob/main/velox/expression/tests/ExpressionFuzzerTest.cpp">ExpressionFuzzerTest.cpp</a>.</p>
<p>A skip function list of UDF names is allowed to specify UDFs not expected to be
tested. UDFs in this list will not appear in the randomly generated
expressions.</p>
</section>
<section id="how-to-run-expression-fuzzer">
<h2>How to run expression fuzzer<a class="headerlink" href="#how-to-run-expression-fuzzer" title="Permalink to this heading">¶</a></h2>
<p>Expression fuzzer allows some powerful command line arguments.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">–-steps</span></code>: How many iterations to run. Each iteration generates and evaluates one expression. Default is 10.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-duration_sec</span></code>: How many seconds to run. If both <code class="docutils literal notranslate"><span class="pre">-–steps</span></code> and <code class="docutils literal notranslate"><span class="pre">-–duration_sec</span></code> are specified, –duration_sec takes effect.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-seed</span></code>: The seed to generate random expressions and input vectors with.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-v=1</span></code>: Verbose logging.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-only</span></code>: A comma-separated list of functions to use in generated expressions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">–-batch_size</span></code>: The size of input vectors to generate. Default is 100.</p></li>
</ul>
<p>If you are running from CLion IDE, add <code class="docutils literal notranslate"><span class="pre">--logtostderr=1</span></code> to see the full
output.</p>
</section>
<section id="how-to-reproduce-fuzzer-test-failures">
<h2>How to reproduce fuzzer test failures<a class="headerlink" href="#how-to-reproduce-fuzzer-test-failures" title="Permalink to this heading">¶</a></h2>
<p>When a fuzzer test fails, a seed number and the evaluated expression are
printed to the log. An example is given below. Developers can use <code class="docutils literal notranslate"><span class="pre">--seed</span></code>
with this seed number to rerun the exact same expression with the same inputs,
and use a debugger to investigate the issue. For the example below, the command
to reproduce the error would be <code class="docutils literal notranslate"><span class="pre">velox/expression/tests/velox_expression_fuzzer_test</span> <span class="pre">--seed</span> <span class="pre">1188545576</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.249965</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">685</span><span class="p">]</span> <span class="o">==============================&gt;</span> <span class="n">Started</span> <span class="n">iteration</span> <span class="mi">38</span>
<span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="mi">1188545576</span><span class="p">)</span>
<span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.250263</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">578</span><span class="p">]</span>
<span class="n">Executing</span> <span class="n">expression</span><span class="p">:</span> <span class="ow">in</span><span class="p">(</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span><span class="mi">10</span> <span class="n">elements</span> <span class="n">starting</span> <span class="n">at</span> <span class="mi">0</span> <span class="p">{</span><span class="mi">120</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="o">-</span><span class="mi">71</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="o">...</span><span class="p">})</span>
<span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.250350</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">581</span><span class="p">]</span> <span class="mi">1</span> <span class="n">vectors</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
<span class="n">I0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.250401</span> <span class="mi">1954756</span> <span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">583</span><span class="p">]</span>     <span class="p">[</span><span class="n">FLAT</span> <span class="n">TINYINT</span><span class="p">:</span> <span class="mi">100</span> <span class="n">elements</span><span class="p">,</span> <span class="mi">6</span> <span class="n">nulls</span><span class="p">]</span>
<span class="n">E0819</span> <span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">52.252044</span> <span class="mi">1954756</span> <span class="n">Exceptions</span><span class="o">.</span><span class="n">h</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span> <span class="n">Line</span><span class="p">:</span> <span class="n">velox</span><span class="o">/</span><span class="n">expression</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">ExpressionFuzzer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">153</span><span class="p">,</span> <span class="n">Function</span><span class="p">:</span><span class="n">compareVectors</span><span class="p">,</span> <span class="n">Expression</span><span class="p">:</span> <span class="n">vec1</span><span class="o">-&gt;</span><span class="n">equalValueAt</span><span class="p">(</span><span class="n">vec2</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="n">Different</span> <span class="n">results</span> <span class="n">at</span> <span class="n">idx</span> <span class="s1">&#39;78&#39;</span><span class="p">:</span> <span class="s1">&#39;null&#39;</span> <span class="n">vs</span><span class="o">.</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">Source</span><span class="p">:</span> <span class="n">RUNTIME</span><span class="p">,</span> <span class="n">ErrorCode</span><span class="p">:</span> <span class="n">INVALID_STATE</span>
<span class="n">terminate</span> <span class="n">called</span> <span class="n">after</span> <span class="n">throwing</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="s1">&#39;facebook::velox::VeloxRuntimeError&#39;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Note that changes to the set of all UDFs to test with invalidates this
reproduction, which can be affected by the skip function list, the <code class="docutils literal notranslate"><span class="pre">--only</span></code>
argument, or the base commit, etc. This is because the chosen UDFs in the
expression are determined by both the seed and the pool of all UDFs to choose
from. So make sure you use the same configuration when reproducing a failure.</p>
</section>
<section id="accurate-on-disk-reproduction">
<h2>Accurate on-disk reproduction<a class="headerlink" href="#accurate-on-disk-reproduction" title="Permalink to this heading">¶</a></h2>
<p>Sometimes developers may want to capture an issue and investigate later,
possibly by someone else using a different machine. Using <code class="docutils literal notranslate"><span class="pre">--seed</span></code> is not
sufficient to accurately reproduce the failure in this scenario. This could be
cased by different behaviors of random generator on different platforms,
additions/removals of UDFs from the list, and etc. To have an accurate
reproduction of a fuzzer failure regardless of environments you can record the
input vector and expression to files and replay these later.</p>
<ol class="arabic simple">
<li><p>Run Fuzzer using <code class="docutils literal notranslate"><span class="pre">--seed</span></code> and <code class="docutils literal notranslate"><span class="pre">--repro_persist_path</span></code> flags to save the input vector and expression to files in the specified directory.</p></li>
<li><p>Run Expression Runner using generated files.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">--repro_persist_path</span> <span class="pre">&lt;path/to/directory&gt;</span></code> flag tells the Fuzzer to save
input vector and expression SQL to files in the specified directory and print
out the exact paths. Fuzzer uses <a class="reference internal" href="vector-saver.html"><span class="doc">VectorSaver</span></a> for storing vectors on disk
while preserving encodings.</p>
<p>ExpressionRunner takes a path to input vector, path to expression SQL and
“mode” and evaluates the specified expression on the specified data.
ExpressionRunner supports the following flags:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--input_path</span></code> path to input vector that was created by the Fuzzer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--sql_path</span></code> path to expression SQL that was created by the Fuzzer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--result_path</span></code> optional path to result vector that was created by the Fuzzer. Result vector is used to reproduce cases where Fuzzer passes dirty vectors to expression evaluation as a result buffer. This ensures that functions are implemented correctly, taking into consideration dirty result buffer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--mode</span></code> run mode. One of “verify”, “common” (default), “simplified”.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">verify</span></code> evaluates the expression using common and simplified paths and compares the results. This is identical to a fuzzer run.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">common</span></code> evaluates the expression using common path and prints the results to stdout.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">simplified</span></code> evaluates the expression using simplified path and prints the results to stdout.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--num_rows</span></code> optional number of rows to process in common and simplified modes. Default: 10. 0 means all rows. This flag is ignored in ‘verify’ mode.</p></li>
</ul>
<p>Example command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">velox</span><span class="o">/</span><span class="n">expression</span><span class="o">/</span><span class="n">tests</span><span class="p">:</span><span class="n">velox_expression_runner_test</span> <span class="o">--</span><span class="n">input_path</span> <span class="s2">&quot;/path/to/input&quot;</span> <span class="o">--</span><span class="n">sql_path</span> <span class="s2">&quot;/path/to/sql&quot;</span> <span class="o">--</span><span class="n">result_path</span> <span class="s2">&quot;/path/to/result&quot;</span>
</pre></div>
</div>
<p>To assist debugging workload, ExpressionRunner supports <code class="docutils literal notranslate"><span class="pre">--sql</span></code> to specify
SQL expression on the command line. <code class="docutils literal notranslate"><span class="pre">--sql</span></code> option can be used standalone to
evaluate constant expression or together with <code class="docutils literal notranslate"><span class="pre">--input_path</span></code> to evaluate
expression on a vector. <code class="docutils literal notranslate"><span class="pre">--sql</span></code> and <code class="docutils literal notranslate"><span class="pre">--sql_path</span></code> flags are mutually
exclusive. If both are specified, <code class="docutils literal notranslate"><span class="pre">--sql</span></code> is used while <code class="docutils literal notranslate"><span class="pre">--sql_path</span></code> is
ignored. <code class="docutils literal notranslate"><span class="pre">--sql</span></code> option allow to specify multiple comma-separated SQL
expressions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ velox/expression/tests:velox_expression_runner_test --sql &quot;pow(2, 3), ceil(1.3)&quot;

I1101 11:32:51.955689 2306506 ExpressionRunner.cpp:127] Evaluating SQL expression(s): pow(2, 3), ceil(1.3)
Result: ROW&lt;_col0:DOUBLE,_col1:DOUBLE&gt;
8 | 2

$ velox/expression/tests:velox_expression_runner_test --sql &quot;pow(2, 3)&quot;

Evaluating SQL expression(s): pow(2, 3)
Result: ROW&lt;_col0:DOUBLE&gt;
8

$ velox/expression/tests:velox_expression_runner_test --sql &quot;array_sort(array[3,6,1,null,2])&quot;
Building: finished in 0.3 sec (100%) 817/3213 jobs, 0/3213 updated

Evaluating SQL expression(s): array_sort(array[3,6,1,null,2])
Result: ROW&lt;_col0:ARRAY&lt;INTEGER&gt;&gt;
[1,2,3,6,null]

$ velox/expression/tests:velox_expression_runner_test --sql &quot;array_sort(array[3,6,1,null,2]), filter(array[1, 2, 3, 4], x -&gt; (x % 2 == 0))&quot;

Evaluating SQL expression(s): array_sort(array[3,6,1,null,2]), filter(array[1, 2, 3, 4], x -&gt; (x % 2 == 0))
Result: ROW&lt;_col0:ARRAY&lt;INTEGER&gt;,_col1:ARRAY&lt;INTEGER&gt;&gt;
[1,2,3,6,null] | [2,4]
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Expression Fuzzer</a><ul>
<li><a class="reference internal" href="#how-to-integrate-with-expression-fuzzer">How to integrate with expression fuzzer</a></li>
<li><a class="reference internal" href="#how-to-run-expression-fuzzer">How to run expression fuzzer</a></li>
<li><a class="reference internal" href="#how-to-reproduce-fuzzer-test-failures">How to reproduce fuzzer test failures</a></li>
<li><a class="reference internal" href="#accurate-on-disk-reproduction">Accurate on-disk reproduction</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="vector-saver.html"
                          title="previous chapter">VectorSaver: Encoding-Preserving Serialization</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../../monthly-updates.html"
                          title="next chapter">Monthly Updates</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/develop/debugging/expression-fuzzer.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../monthly-updates.html" title="Monthly Updates"
             >next</a> |</li>
        <li class="right" >
          <a href="vector-saver.html" title="VectorSaver: Encoding-Preserving Serialization"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Velox  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../develop.html" >Developer Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../debugging.html" >Debugging Tools</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Expression Fuzzer</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright TBD.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>